<?php
/**
 * Created by PhpStorm.
 * User: HP
 * Date: 07-Jun-17
 * Time: 7:58 PM
 */

namespace App\Controllers\Admin;

use \App\Models\Admin\Notification;
use App\Pagination;
use \Core\View;
use \App\Flash;


class Notifications extends \Core\Admin {


    public function before()
    {
        parent::before(); // TODO: Change the autogenerated stub
    }


    // renders page with all notifications
    public function allNotificationsAction(){

        // query string from Only unread button
        $sort = $_GET['sort'] ?? false;

        // pagination
        // get count of all notifications or only unread if specified
        $count = $sort ? count(Notification::getAllNotifications(false, true, false)) : count(Notification::getAllNotifications());
        $current_page   = $_GET['page'] ?? 1;
        $items_per_page = 10;
        $pagination     = new Pagination($current_page, $items_per_page, $count);
        //print_r($pagination);

        // get all notifications or only unread if specified
        $notifications = $sort ? Notification::getAllNotifications(false, true, $items_per_page, $pagination->offset) : Notification::getAllNotifications(false, false, $items_per_page, $pagination->offset);

        //print_r($notifications);
        if($notifications){

            View::renderTemplate('admin/notifications/all_notifications.html', [
                'notifications' => $notifications,
                'sort'          => $sort,
                'pagination'    => $pagination
             ]);

        } else {

            Flash::addMessage('There are no notifications', Flash::INFO);
            View::renderTemplate('admin/notifications/all_notifications.html', ['empty' => 1]);

        }

    }


    // this method sets a notification as viewed
    public static function setAsReadAction(){

        $notification_id = $_POST['notification_id'] ?? false;

        if($notification_id){

            Notification::setAsRead($notification_id);
            return true;

        }
        return false;
    }

    // this method deletes checked notifications
    public function deleteCheckedAction(){

        $ids = $_POST;

        if( ! empty($ids)){

            foreach ($ids as $id){
                $notification = Notification::delete($id);
            }

            self::redirect('/admin/notifications/all-notifications');

        }

    }

}