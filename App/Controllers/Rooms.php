<?php
/**
 * Created by PhpStorm.
 * User: HP
 * Date: 24-Jun-17
 * Time: 2:21 PM
 */

namespace App\Controllers;


use App\Models\Admin\Room;
use App\Pagination;
use Core\View;
use App\Models\Admin\Search;
use App\Models\Admin\Booking;
use App\Flash;
use App\Mail;

class Rooms extends \Core\Controller {

    public function before()
    {
        parent::before(); // TODO: Change the autogenerated stub
    }


    // search by dates or by dates and num_guests and smoking
    public function searchResultsAction(){

        //print_r($_POST);

        $checkin  = $_POST['checkin'] ?? $_GET['checkin'] ?? false;
        $checkout = $_POST['checkout'] ?? $_GET['checkout'] ?? false;
        $smoking  = $_POST['smoking'] ?? $_GET['smoking'] ?? false;
        $guests   = $_POST['num_guests'] ?? $_GET['num_guests'] ?? false;

        if($checkin && $checkout){

            $count = count(Search::findRoomsByDates($checkin, $checkout, $smoking, $guests));
            $items_per_page = 5;
            $current_page = $_GET['page'] ?? 1;

            $pagination = new Pagination($current_page, $items_per_page, $count);

            $rooms = Search::findRoomsByDates($checkin, $checkout, $smoking, $guests);
            $offset = ($pagination->offset && ($pagination->offset > 0)) ? $pagination->offset : 0;
            $rooms = array_slice($rooms, $offset, $items_per_page);

            View::renderTemplate('rooms/search_results.html', [
                'rooms'      => $rooms,
                'pagination' => $pagination,
                'checkin'    => $checkin,
                'checkout'   => $checkout,
                'smoking'    => $smoking,
                'num_guests' => $guests
            ]);


        }

    }

    public function prebookRoomAction(){

        $checkin = $_GET['checkin']   ?? false;
        $checkout = $_GET['checkout'] ?? false;
        $room_id  = $_GET['id'] ?? false;

        if($room_id){
            $room = Room::findById($room_id);

            View::renderTemplate('rooms/prebook_room.html', [
                'checkin'  => $checkin,
                'checkout' => $checkout,
                'room'     => $room
            ]);
        } else {
            Flash::addMessage('There is no such a room');
            self::redirect('/home/index');
        }


    }




    // creates booking f
    public function bookRoomAction(){

        $data = $_POST ?? false;
        $room_name = $_POST['local_name'] ?? false;

        if(!empty($data)){

            // create a new Booking object based on POST data
            $booking = new Booking($data);

            // call Booking model's method to create a record in the database and proceed on success

            if($booking->newBooking($room_name)){

                Flash::addMessage('Your booking was created successfully');
                // get current user's object
                Mail::send($data['email'], 'MyHotelSystem', 'New booking', View::getTemplate('admin/bookings/booking_email.html', [
                    'booking' => $booking,
                    'room_name' => $room_name
                ]));


               View:: renderTemplate('/rooms/booked_successfully.html',[
                    'booking'   => $booking,
                    'room_name' => $room_name
                ]);

            } else {
                Flash::addMessage('There was a problem processing your requests, please try again');
                self::redirect('/rooms/prebook-room?checkin='. $data['checkin'] . '&checkout=' . $data['checkout'] . '&id=' .$data['room_id']);
            }
        } else {
            self::redirect('home/index');
        }
    }

}